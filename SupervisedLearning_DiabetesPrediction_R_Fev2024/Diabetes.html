<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>dm_diabetes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="DM_Diabetes_files/libs/clipboard/clipboard.min.js"></script>
<script src="DM_Diabetes_files/libs/quarto-html/quarto.js"></script>
<script src="DM_Diabetes_files/libs/quarto-html/popper.min.js"></script>
<script src="DM_Diabetes_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="DM_Diabetes_files/libs/quarto-html/anchor.min.js"></script>
<link href="DM_Diabetes_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="DM_Diabetes_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="DM_Diabetes_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="DM_Diabetes_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="DM_Diabetes_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<section id="prédiction-du-diabète-par-classification-supervisée" class="level1">
<h1>Prédiction du Diabète par Classification Supervisée</h1>
<section id="i--chargement-et-prétraitement-des-données" class="level2">
<h2 class="anchored" data-anchor-id="i--chargement-et-prétraitement-des-données">I- Chargement et prétraitement des données</h2>
<p>Cette phase correspondra à un traitement minimal du dataset permettant de lancer les divers algorithmes de classification et d’apprécier un potentiel de performance, avant une deuxième phase qui correspondera à des traitements plus poussés afin d’optimiser la finesse de la prédiction</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-1_8ffb730fa46b10d3e3be324714459eb5">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chargement du dataset et visualisation </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df_brut <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"data/diabetes.csv"</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_brut)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Pregnancies Glucose BloodPressure SkinThickness Insulin  BMI
1           6     148            72            35       0 33.6
2           1      85            66            29       0 26.6
3           8     183            64             0       0 23.3
4           1      89            66            23      94 28.1
5           0     137            40            35     168 43.1
6           5     116            74             0       0 25.6
  DiabetesPedigreeFunction Age Outcome
1                    0.627  50       1
2                    0.351  31       0
3                    0.672  32       1
4                    0.167  21       0
5                    2.288  33       1
6                    0.201  30       0</code></pre>
</div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-2_e9c73be23887a9ce3c3954425987b772">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examiner le dataset brut</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df_brut)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   768 obs. of  9 variables:
 $ Pregnancies             : int  6 1 8 1 0 5 3 10 2 8 ...
 $ Glucose                 : int  148 85 183 89 137 116 78 115 197 125 ...
 $ BloodPressure           : int  72 66 64 66 40 74 50 0 70 96 ...
 $ SkinThickness           : int  35 29 0 23 35 0 32 0 45 0 ...
 $ Insulin                 : int  0 0 0 94 168 0 88 0 543 0 ...
 $ BMI                     : num  33.6 26.6 23.3 28.1 43.1 25.6 31 35.3 30.5 0 ...
 $ DiabetesPedigreeFunction: num  0.627 0.351 0.672 0.167 2.288 ...
 $ Age                     : int  50 31 32 21 33 30 26 29 53 54 ...
 $ Outcome                 : int  1 0 1 0 1 0 1 0 1 1 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df_brut)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Pregnancies        Glucose      BloodPressure    SkinThickness  
 Min.   : 0.000   Min.   :  0.0   Min.   :  0.00   Min.   : 0.00  
 1st Qu.: 1.000   1st Qu.: 99.0   1st Qu.: 62.00   1st Qu.: 0.00  
 Median : 3.000   Median :117.0   Median : 72.00   Median :23.00  
 Mean   : 3.845   Mean   :120.9   Mean   : 69.11   Mean   :20.54  
 3rd Qu.: 6.000   3rd Qu.:140.2   3rd Qu.: 80.00   3rd Qu.:32.00  
 Max.   :17.000   Max.   :199.0   Max.   :122.00   Max.   :99.00  
    Insulin           BMI        DiabetesPedigreeFunction      Age       
 Min.   :  0.0   Min.   : 0.00   Min.   :0.0780           Min.   :21.00  
 1st Qu.:  0.0   1st Qu.:27.30   1st Qu.:0.2437           1st Qu.:24.00  
 Median : 30.5   Median :32.00   Median :0.3725           Median :29.00  
 Mean   : 79.8   Mean   :31.99   Mean   :0.4719           Mean   :33.24  
 3rd Qu.:127.2   3rd Qu.:36.60   3rd Qu.:0.6262           3rd Qu.:41.00  
 Max.   :846.0   Max.   :67.10   Max.   :2.4200           Max.   :81.00  
    Outcome     
 Min.   :0.000  
 1st Qu.:0.000  
 Median :0.000  
 Mean   :0.349  
 3rd Qu.:1.000  
 Max.   :1.000  </code></pre>
</div>
</div>
<section id="réencodage-de-la-variable-catégorielle" class="level3">
<h3 class="anchored" data-anchor-id="réencodage-de-la-variable-catégorielle">1- Réencodage de la variable catégorielle</h3>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-3_6555e41456ec129fb019270762468ad2">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Conversion</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df_brut<span class="sc">$</span>Outcome <span class="ot">=</span> <span class="fu">factor</span>(df_brut<span class="sc">$</span>Outcome)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier les niveaux du facteur</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(df_brut<span class="sc">$</span>Outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0" "1"</code></pre>
</div>
</div>
</section>
<section id="détection-déventuelles-observations-dupliquées" class="level3">
<h3 class="anchored" data-anchor-id="détection-déventuelles-observations-dupliquées">2- Détection d’éventuelles observations dupliquées</h3>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-4_05c3e133ab40c1a6b946734c13189106">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Détecter les duplicata</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>duplicated <span class="ot">=</span> <span class="fu">duplicated</span>(df_brut)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(duplicated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Il n'existe pas d'observations redondantes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="détection-des-valeurs-manquantes" class="level3">
<h3 class="anchored" data-anchor-id="détection-des-valeurs-manquantes">3- Détection des valeurs manquantes</h3>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-5_12510a9b573d394d8ef9a2ab1321dff7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Racherche de NA:</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>total_na <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(df_brut))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>total_na</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-6_8a909ac58f9d1f9ea24276d264627ac0">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recherche de valeurs manquantes encodées autrement, exploration du minimum des mesures </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>valeurs_minimales <span class="ot">=</span> <span class="fu">sapply</span>(df_brut[, <span class="sc">-</span><span class="dv">9</span>], min)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(valeurs_minimales)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Pregnancies                  Glucose            BloodPressure 
                   0.000                    0.000                    0.000 
           SkinThickness                  Insulin                      BMI 
                   0.000                    0.000                    0.000 
DiabetesPedigreeFunction                      Age 
                   0.078                   21.000 </code></pre>
</div>
</div>
<p>Les variables “SkinThickness”, “Glucose”,“BloodPressure”,“BMI”, “Insulin” ne peuvent avoir une valeur de 0 car ceci est impossible physiquement, la valeur 0 pour ces variables sera interprétée comme valeur manquante.</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-7_19c6120cb48a64e3b4e555b22fd67b90">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identifier les indices et le nombre de valeurs manquantes par variable</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>variables_a_verifier <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"SkinThickness"</span>, <span class="st">"Glucose"</span>, <span class="st">"BloodPressure"</span>, <span class="st">"BMI"</span>, <span class="st">"Insulin"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Identifier les indices des valeurs de 0 pour chaque variable </span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>indices_zero <span class="ot">=</span> <span class="fu">lapply</span>(df_brut[variables_a_verifier], <span class="cf">function</span>(x) <span class="fu">which</span>(x <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compter le nombre de zéros (valeurs manquantes) pour chaque variable</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>nombre_zeros <span class="ot">=</span> <span class="fu">sapply</span>(indices_zero, length)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculer le pourcentage de valeurs manquantes encodées comme 0 pour chaque variable</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>pourcentage_zeros <span class="ot">=</span> nombre_zeros <span class="sc">/</span> <span class="fu">nrow</span>(df_brut) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un dataframe pour un affichage plus clair</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>resultats <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">NombreZeros =</span> nombre_zeros, <span class="at">PourcentageZeros =</span> pourcentage_zeros)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Afficher les résultats</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resultats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              NombreZeros PourcentageZeros
SkinThickness         227       29.5572917
Glucose                 5        0.6510417
BloodPressure          35        4.5572917
BMI                    11        1.4322917
Insulin               374       48.6979167</code></pre>
</div>
</div>
</section>
<section id="imputation-des-valeurs-manquantes" class="level3">
<h3 class="anchored" data-anchor-id="imputation-des-valeurs-manquantes">3- Imputation des valeurs manquantes</h3>
<ul>
<li>Raisonnement et choix</li>
</ul>
<p>Appliquer des algorithmes comme l’imputation par PCA de missMDA est tentant, mais la méthode n’est pas bien appropriée pour aussi peu d’observations et des taux aussi élevés de valeurs manquantes, surtout qu’une seule ligne peut contenir plusieurs valeurs manquantes. Des tests ont été réalisés et ont donné des taux de bonnes prédictions qui était exagérément haut pour un set aussi réduit et des mesures médicales impliquant des marges d’erreur.</p>
<p>Le choix se tourne donc vers une imputation plus robuste (au regard des caractéristiques initiales du dataset), on applique un algorithme des plus proches voisins.</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-8_bb3a582ca590a72cd8b4b27d08a64c5d">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># La librairie knn pour imputation que l'on va utiliser, gère des valeurs manquantes de type NA, alors on ré-encode les valeurs manquantes en NA</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>df_brut[variables_a_verifier] <span class="ot">=</span> <span class="fu">lapply</span>(df_brut[variables_a_verifier], <span class="cf">function</span>(x) <span class="fu">ifelse</span>(x <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, x))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># vérification du réencodage</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(df_brut))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 652</code></pre>
</div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-9_aa594c994cd02416e36af13f51f2aa38">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imputation par les plus proches voisins</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"DMwR2"</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>df_imputed <span class="ot">=</span> <span class="fu">knnImputation</span>(df_brut, <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérification</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(df_imputed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
</section>
</section>
<section id="ii--modélisations-et-prédictions-sur-les-données-traitées-de-façon-minimaliste" class="level2">
<h2 class="anchored" data-anchor-id="ii--modélisations-et-prédictions-sur-les-données-traitées-de-façon-minimaliste">II- Modélisations et prédictions sur les données traitées de façon minimaliste</h2>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-10_9fbd01c89549328be39c2430bdaf56ca">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Isolation d'un set de test</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_imputed), <span class="dv">100</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> df_imputed[<span class="sc">-</span>indices,]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>test  <span class="ot">=</span> df_imputed[indices,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="classification-par-plus-proches-voisins" class="level3">
<h3 class="anchored" data-anchor-id="classification-par-plus-proches-voisins">1- Classification par plus proches voisins</h3>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-11_7a04b9685010703da06a869b79e5d8eb">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Partage en features et labels</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">=</span> train[, <span class="sc">-</span><span class="dv">9</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">=</span> train[,<span class="dv">9</span>]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">=</span> test[, <span class="sc">-</span><span class="dv">9</span>]</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">=</span> test[, <span class="dv">9</span>]</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Trouver une valeur optimale du nombre de voisins en cross-validation</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(class)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>tbc<span class="ot">=</span><span class="cn">NULL</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  tmp<span class="ot">=</span><span class="fu">knn.cv</span>(X_train, y_train,<span class="at">k=</span>k)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  tbc<span class="ot">=</span><span class="fu">c</span>(tbc,<span class="fu">mean</span>(tmp<span class="sc">==</span>y_train))</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tbc,<span class="at">type=</span><span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="DM_Diabetes_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-12_2a500f0cd0a9c9def9f10a1f7421b39b">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Entrainer le modèle avec k optimal et récupérer les prédictions</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>mod_knn_simple <span class="ot">=</span> <span class="fu">knn</span>(X_train,X_test,y_train,<span class="at">k=</span><span class="fu">which.max</span>(tbc))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonnes prédictions knn</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>tbc_knn <span class="ot">=</span> <span class="fu">mean</span>(mod_knn_simple <span class="sc">==</span> y_test)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>tbc_knn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.71</code></pre>
</div>
</div>
</section>
<section id="classification-par-arbre-de-décision-méthode-cart" class="level3">
<h3 class="anchored" data-anchor-id="classification-par-arbre-de-décision-méthode-cart">2- Classification Par arbre de décision, méthode cart</h3>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-13_5c7fe26a564134aec3eb20ee5fb77c8a">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'rpart'</span>);<span class="fu">library</span>(<span class="st">'rpart.plot'</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle d'arbre de décision avec la méthode cart</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>mod_dt_simple <span class="ot">=</span> <span class="fu">rpart</span>(Outcome<span class="sc">~</span>.,<span class="at">data=</span>train)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prédiction sur le set de test</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>p<span class="ot">=</span><span class="fu">predict</span>(mod_dt_simple,<span class="at">newdata =</span> test,<span class="at">type=</span><span class="st">'class'</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagramme de l'arbre de décision</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(mod_dt_simple)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="DM_Diabetes_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-14_7d6a8ceb1301d93ae75608864f1a46e4">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonne classification par arbre de décision :</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>tbc_dt <span class="ot">=</span> <span class="fu">mean</span>(p<span class="sc">==</span>test<span class="sc">$</span>Outcome)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>tbc_dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7</code></pre>
</div>
</div>
</section>
<section id="classification-par-forêts-aléatoires" class="level3">
<h3 class="anchored" data-anchor-id="classification-par-forêts-aléatoires">3- Classification par forêts aléatoires</h3>
<p>Ici, le nombre de variables à piocher au hasard, paramètre “mtry” est optimisé en itérant sur les différentes valeurs possibles et en choisissant le k minimisant l’erreur OOB.</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-15_541135745545a3e06a411a3c72d1e62a">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Boucle sur les valeurs possibles de "mtry"</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>oob_errors <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>) {</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  mod_rf <span class="ot">=</span> <span class="fu">randomForest</span>(Outcome<span class="sc">~</span>., <span class="at">data=</span>train, <span class="at">ntree=</span><span class="dv">10000</span>, <span class="at">mtry=</span>k)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  oob_errors[k] <span class="ot">=</span> mod_rf<span class="sc">$</span>err.rate[<span class="fu">nrow</span>(mod_rf<span class="sc">$</span>err.rate),<span class="dv">1</span>]</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Graphique de l'erreur Out Of Bag en fonction du nombre de variables piochées</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(oob_errors,<span class="at">type=</span><span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="DM_Diabetes_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-16_e18f75916f54429da864b747ec34e026">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modéle RF avec le paramètre mtry minimisant l'erreur OOB</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>mod_rf_simple <span class="ot">=</span> <span class="fu">randomForest</span>(Outcome<span class="sc">~</span>.,<span class="at">data=</span>train, <span class="at">ntree=</span><span class="dv">10000</span>, <span class="at">mtry=</span><span class="fu">which.min</span>(oob_errors))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Prédiction</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>p<span class="ot">=</span><span class="fu">predict</span>(mod_rf_simple,<span class="at">newdata =</span> test,<span class="at">type=</span><span class="st">'class'</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonne classification RF</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>tbc_rf <span class="ot">=</span> <span class="fu">mean</span>(p<span class="sc">==</span>test<span class="sc">$</span>Outcome)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>tbc_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.71</code></pre>
</div>
</div>
</section>
<section id="classification-par-svm" class="level3">
<h3 class="anchored" data-anchor-id="classification-par-svm">4- Classification par SVM</h3>
<p>Ici, pour ne pas compliquer le code, ni réduire les données train, le set test est utilisé pour la recherche du meilleur kernel de la SVM. En temps normal on se servirait de cross validation pour l’optimisation, ou on réserverait un set de validation.</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-17_a3c29ed1ae9b41d99b435d9b44fa0012">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kernlab)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Définir une liste des kernels à tester</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>kernels <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"rbfdot"</span>, <span class="st">"polydot"</span>, <span class="st">"tanhdot"</span>, <span class="st">"laplacedot"</span>, <span class="st">"besseldot"</span>, <span class="st">"anovadot"</span>, <span class="st">"splinedot"</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialiser une liste pour stocker les modèles SVM</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>svm_models <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialiser une liste pour stocker les résultats</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>svm_results <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>tbc_svm <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Boucler sur les différents kernels</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (kernel <span class="cf">in</span> kernels) {</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entraîner le modèle SVM avec le kernel actuel</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  svm_model <span class="ot">=</span> <span class="fu">ksvm</span>(Outcome <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">scaled =</span> <span class="cn">FALSE</span>, <span class="at">kernel =</span> kernel)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stocker le modèle dans la liste</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  svm_models[[kernel]] <span class="ot">=</span> svm_model</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Faire des prédictions sur l'ensemble de test</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  pred_svm <span class="ot">=</span> <span class="fu">predict</span>(svm_model, <span class="at">newdata =</span> test)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Créer et stocker la matrice de confusion</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>  svm_results[[kernel]] <span class="ot">=</span> <span class="fu">table</span>(<span class="at">Predicted =</span> pred_svm, <span class="at">Actual =</span> test<span class="sc">$</span>Outcome)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># et le taux de bonnes prédictions</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>  tbc_svm <span class="ot">=</span> <span class="fu">c</span>(tbc_svm, <span class="fu">mean</span>(pred_svm <span class="sc">==</span> test<span class="sc">$</span>Outcome))</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Setting default kernel parameters  
 Setting default kernel parameters  
 Setting default kernel parameters  
 Setting default kernel parameters  
 Setting default kernel parameters  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Afficher les résultats</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tbc_svm , <span class="at">type =</span><span class="st">"l"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="DM_Diabetes_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Pour la SVM, le Kernel polynomial, semble donner les meilleur résultat en phase de recherche</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-18_2bb33714ea7744581b251dc603f5e30e">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A prendre avec précaution car pas calculé sur des données de validation encore</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>tbc_svm[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.71</code></pre>
</div>
</div>
</section>
<section id="classification-par-régression-logistique" class="level3">
<h3 class="anchored" data-anchor-id="classification-par-régression-logistique">5- Classification par régression logistique</h3>
<ul>
<li>régression simple</li>
</ul>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-19_d9abb38e7de1878f52a8956bba15ff53">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(VGAM)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle de régression logistique </span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>mod_reglog_simple <span class="ot">=</span> <span class="fu">vglm</span>(Outcome <span class="sc">~</span> ., <span class="at">family =</span> <span class="fu">binomialff</span>(<span class="at">link =</span> <span class="st">"logitlink"</span>), <span class="at">data =</span> train)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcul de la probabilité d'avoir le diabète</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">predict</span>(mod_reglog_simple, <span class="at">newdata =</span> test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Conversion de la probabilité en classe </span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ifelse</span>(prob <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonnes prédictions</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>tbc_reglog <span class="ot">=</span> <span class="fu">mean</span>(p<span class="sc">==</span>test<span class="sc">$</span>Outcome)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>tbc_reglog</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.69</code></pre>
</div>
</div>
<ul>
<li>Régression pénalisée Lasso, sans optimisation du paramètre lambda</li>
</ul>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-20_de87946040e2fb1446a2d0e1a9a12be3">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle de régression Lasso </span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>mod_reglasso_simple <span class="ot">=</span><span class="fu">glmnet</span>(train[, <span class="sc">-</span><span class="dv">9</span>],train<span class="sc">$</span>Outcome,<span class="at">alpha=</span><span class="dv">1</span>,<span class="at">family=</span><span class="st">"binomial"</span>,<span class="at">lambda=</span><span class="fl">0.01</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prédiction</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">predict</span>(mod_reglasso_simple, <span class="at">newx =</span> <span class="fu">as.matrix</span>(test[,<span class="sc">-</span><span class="dv">9</span>]),<span class="at">type=</span><span class="st">'class'</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonnes prédictions</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>tbc_reglasso <span class="ot">=</span> <span class="fu">mean</span>(p <span class="sc">==</span> test<span class="sc">$</span>Outcome)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>tbc_reglasso</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7</code></pre>
</div>
</div>
<ul>
<li>Régression pénalisé Lasso avec recherche d’un lambda optimal par cross validation</li>
</ul>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-21_98b4fce4e72fd4c6550bdce217be674f">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle de régression Lasso avec optimisation de Lambda par Cv</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>mod_reglasso_cv <span class="ot">=</span> <span class="fu">cv.glmnet</span>(<span class="fu">as.matrix</span>(train[,<span class="sc">-</span><span class="dv">9</span>]), <span class="fu">as.matrix</span>(train[,<span class="dv">9</span>]), <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">family=</span><span class="st">"binomial"</span>, <span class="at">nfolds =</span> <span class="dv">62</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Lambda optimal ( ici celle qui minimise le plus l'erreur de la validation croisée)</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>best_lambda <span class="ot">=</span> mod_reglasso_cv<span class="sc">$</span>lambda.min <span class="co"># 1se sinon</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajustement d un modèle de régression Lasso avec cette valeur de lambda</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>mod_reglasso_optimise <span class="ot">=</span> <span class="fu">glmnet</span>(train[, <span class="sc">-</span><span class="dv">9</span>], train<span class="sc">$</span>Outcome, <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">family=</span><span class="st">"binomial"</span>, <span class="at">lambda=</span>best_lambda)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">predict</span>(mod_reglasso_optimise, <span class="at">newx =</span> <span class="fu">as.matrix</span>(test[,<span class="sc">-</span><span class="dv">9</span>]),<span class="at">type=</span><span class="st">'class'</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonnes Classification</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>tbc_reglasso_opt <span class="ot">=</span> <span class="fu">mean</span>(p <span class="sc">==</span> test<span class="sc">$</span>Outcome)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>tbc_reglasso_opt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7</code></pre>
</div>
</div>
</section>
</section>
<section id="iii--phase-dingénierie-de-linformation" class="level2">
<h2 class="anchored" data-anchor-id="iii--phase-dingénierie-de-linformation">III- Phase d’ingénierie de l’information</h2>
<p>Les premiers modèles, lancés sur des données traitées de façon minimaliste, sont prometteurs en particulier pour les random forests et la régression logistique. Dans cette deuxième phase nous essayons de combler des faiblesses du dataset initial et d’améliorer la qualité de l’apprentissage.</p>
<section id="détection-des-outliers" class="level3">
<h3 class="anchored" data-anchor-id="détection-des-outliers">1- Détection des Outliers</h3>
<p>Plusieurs variables ont des valeurs extrêmes, isolons les observations à une distance de plus de trois équarts types de la moyenne:</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-22_9f18db26b89dfb2dd20159a7061fb4d8">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fonction pour détecter les outliers, basée sur le score Z ( distance de plus de 3 équarts type de la moyenne)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>detect_outliers_z <span class="ot">=</span> <span class="cf">function</span>(data, <span class="at">threshold =</span> <span class="dv">3</span>) {</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  z_scores <span class="ot">=</span> <span class="fu">scale</span>(data) <span class="co"># Calcul des scores Z</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  abs_z_scores <span class="ot">=</span> <span class="fu">abs</span>(z_scores)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  outlier_indices <span class="ot">=</span> <span class="fu">which</span>(abs_z_scores <span class="sc">&gt;</span> threshold, <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Créer un dataframe pour une meilleure lisibilité</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  outliers_df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">row =</span> outlier_indices[, <span class="st">"row"</span>],</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">col =</span> outlier_indices[, <span class="st">"col"</span>])</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ajouter les noms des colonnes pour les indices de colonnes</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  outliers_df<span class="sc">$</span>col_name <span class="ot">=</span> <span class="fu">colnames</span>(data)[outliers_df<span class="sc">$</span>col]</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extraire la valeur aberrante pour chaque outlier détecté</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  outliers_df<span class="sc">$</span>outlier_value <span class="ot">=</span> <span class="fu">mapply</span>(<span class="cf">function</span>(row, col) data[row, col], outliers_df<span class="sc">$</span>row, outliers_df<span class="sc">$</span>col)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(outliers_df)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Détection des outliers par la fonction élaborée ci-dessus</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>outliers_z <span class="ot">=</span> <span class="fu">detect_outliers_z</span>(df_imputed[,<span class="sc">-</span><span class="dv">9</span>])</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>outliers_z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   row col                 col_name outlier_value
1   89   1              Pregnancies        15.000
2  160   1              Pregnancies        17.000
3  299   1              Pregnancies        14.000
4  456   1              Pregnancies        14.000
5   19   3            BloodPressure        30.000
6   44   3            BloodPressure       110.000
7  107   3            BloodPressure       122.000
8  126   3            BloodPressure        30.000
9  178   3            BloodPressure       110.000
10 550   3            BloodPressure       110.000
11 598   3            BloodPressure        24.000
12 692   3            BloodPressure       114.000
13  58   4            SkinThickness        60.000
14 446   4            SkinThickness        63.000
15 580   4            SkinThickness        99.000
16   9   5                  Insulin       543.000
17  14   5                  Insulin       846.000
18 112   5                  Insulin       495.000
19 154   5                  Insulin       485.000
20 187   5                  Insulin       495.000
21 221   5                  Insulin       478.000
22 229   5                  Insulin       744.000
23 248   5                  Insulin       680.000
24 287   5                  Insulin       545.000
25 371   5                  Insulin       465.000
26 410   5                  Insulin       579.000
27 416   5                  Insulin       474.000
28 487   5                  Insulin       480.000
29 585   5                  Insulin       600.000
30 656   5                  Insulin       540.000
31 696   5                  Insulin       480.000
32 754   5                  Insulin       510.000
33 121   6                      BMI        53.200
34 126   6                      BMI        55.000
35 178   6                      BMI        67.100
36 446   6                      BMI        59.400
37 674   6                      BMI        57.300
38   5   7 DiabetesPedigreeFunction         2.288
39  46   7 DiabetesPedigreeFunction         1.893
40  59   7 DiabetesPedigreeFunction         1.781
41 229   7 DiabetesPedigreeFunction         2.329
42 331   7 DiabetesPedigreeFunction         1.476
43 371   7 DiabetesPedigreeFunction         2.137
44 372   7 DiabetesPedigreeFunction         1.731
45 396   7 DiabetesPedigreeFunction         1.600
46 446   7 DiabetesPedigreeFunction         2.420
47 594   7 DiabetesPedigreeFunction         1.699
48 622   7 DiabetesPedigreeFunction         1.698
49 124   8                      Age        69.000
50 454   8                      Age        72.000
51 460   8                      Age        81.000
52 667   8                      Age        70.000
53 685   8                      Age        69.000</code></pre>
</div>
</div>
<ul>
<li><p>Raisonnement et choix par rapport au outliers :</p>
<p>La détection des outliers isole 54 valeurs extrêmes dans 48 observations, elles ont été revues une à une.</p>
<p>Bien que les valeurs extrêmes sur des données médicales soient souvent une source d’information sur une condition en particulier (l’écart par rapport à une norme est médicalement un symptôme), leur supression ici serait plus prudente.</p>
<p>En effet, le but de la modélisation est la détection précoce du diabète, dans une démarche de prévention, chez des personnes qui pourraient échapper à un suivi médical régulier. Les Outliers détectés, quand ils ne sont pas des erreurs de saisie, sont tous assez extrêmes pour imposer au sujet concerné une prise en charge médicale régulière, qui incluerait un simple test fiable de détection du diabète.</p>
<p>Le choix est donc de supprimer les observations contenant des Outliers.</p></li>
</ul>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-23_783a9825773942ba229c7001f6a30f7e">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppression des observations contenant des outliers</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>df_imputed_wo <span class="ot">=</span> df_imputed[<span class="sc">-</span>outliers_z<span class="sc">$</span>row, ]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérification de la nouvelle dimension du df après suppression des outliers</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(df_imputed_wo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 721   9</code></pre>
</div>
</div>
</section>
<section id="construction-de-nouvelles-variables" class="level3">
<h3 class="anchored" data-anchor-id="construction-de-nouvelles-variables">2- Construction de nouvelles variables</h3>
<ul>
<li><p>Raisonnement et choix :</p>
<p>D’après le modèle RF lancé précédemment, les deux variables “Glucose” et “Insulin” sont les plus importantes dans la prédiction. Les variables choisies dans ce dataset sont orientées à la détection du diabète d’insulinorésistance. Le nombre total de variables dont nous disposons est limité et nous permet d’envisager des transformations pour en construire des nouvelles.</p>
<p>L’idée est d’appliquer une transformation logarithmique sur ces deux variables, et de considérer le ratio glucose/insuline pour la sensibilité à l’insuline, ainsi que leur produit glucose*insuline pour la charge métabolique nécessaire à utiliser le glucose.</p>
<p>Une idée de catégorisation des différentes variables serait très intérresante, car elle prendrait en compte des seuils et améliorerait l’interprétabilité, mais engagerait un travail d’ingénierie de la donnée conséquent qui nuirait au focus “apprentissage supervisé” de ce travail.</p>
<p>En tout, quatre nouvelles variables seront construites:</p>
<ul>
<li><p>Logarithme de la variable Glucose : log_G</p></li>
<li><p>Logarithme de la variable Insuline : log_I</p></li>
<li><p>ratio_GI : log_G/log_I</p></li>
<li><p>produit_GI : log_G * log_I</p></li>
</ul></li>
</ul>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-24_afee7355e6a7bbcd79f4aea8f240db67">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construction des nouvelles variables:</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>df_imputed_wo<span class="sc">$</span>log_G <span class="ot">=</span> <span class="fu">log</span>(df_imputed_wo<span class="sc">$</span>Glucose)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>df_imputed_wo<span class="sc">$</span>log_I <span class="ot">=</span> <span class="fu">log</span>(df_imputed_wo<span class="sc">$</span>Insulin)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>df_imputed_wo<span class="sc">$</span>ratio_GI <span class="ot">=</span> df_imputed_wo<span class="sc">$</span>log_G <span class="sc">/</span> df_imputed_wo<span class="sc">$</span>log_I</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>df_imputed_wo<span class="sc">$</span>produit_GI <span class="ot">=</span> df_imputed_wo<span class="sc">$</span>log_G <span class="sc">*</span> df_imputed_wo<span class="sc">$</span>log_I</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co"># remettre Outcome en dernière position</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">=</span> df_imputed_wo<span class="sc">$</span>Outcome</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>df_imputed_wo<span class="ot">=</span> df_imputed_wo[,<span class="sc">-</span><span class="dv">9</span>]</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>df_imputed_wo<span class="sc">$</span>Outcome <span class="ot">=</span> tmp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="equilibrage-des-données-dans-la-variable-prédite" class="level3">
<h3 class="anchored" data-anchor-id="equilibrage-des-données-dans-la-variable-prédite">3- Equilibrage des données dans la variable prédite</h3>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-25_adc55bc16431e263a764916decdd86cf">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># copie pour pouvoir retrouver df_imputed_wo à cette étape si impondérable</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> df_imputed_wo[,]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ratio issue diabétique par rapport à non diabétique:</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>outcome_counts <span class="ot">=</span> <span class="fu">table</span>(df<span class="sc">$</span>Outcome)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>outcome_percentages <span class="ot">=</span> <span class="fu">prop.table</span>(outcome_counts) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(outcome_percentages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
       0        1 
66.43551 33.56449 </code></pre>
</div>
</div>
<ul>
<li>Raisonnement et choix :</li>
</ul>
<p>Les deux classes sont déséquilibrées en faveur de la classe non diabétique, ce qui pourrait favoriser l’erreur de type 2, un faux négatif, particulièrement dangereux en prédiction des maladies. En effet un faux positif pourrait facilement être vérifié par des tests poussés alors qu’un patient malade qui ne le sait pas court des risques.</p>
<p>Les algorithmes utilisés ne gérent pas tous ce déséquilibre.</p>
<p>La quantité de d’observations dont nous disposons est limitée, le choix d’équilibrage se tourne vers un sur-échantillonnage avec la technique smote (<a href="https://doi.org/10.1613/jair.953" class="uri">https://doi.org/10.1613/jair.953</a>), qui semble fiable et applicable à notre dataset. Le suréchantillonge sera appliqué aux données de training, le set de test sera abord isolé pour éviter une fuite potentielle d’information.</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-26_0b31e09a3b6efe695997ae53df9452f1">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split en train-test</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(df), <span class="dv">100</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ici nomenclature train2 et test2 pour différencier avec train et test ayant servi à la phase préliminaire</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">=</span> df[<span class="sc">-</span>indices,]</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">=</span> df[indices,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-27_cd2f3d0388909f05a62ba65b461a855b">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># appliquer l'algorithme SMOTE pour équilibrer les classes</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(performanceEstimation)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">=</span>  <span class="fu">smote</span>(Outcome <span class="sc">~</span> ., train2, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">perc.over =</span><span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Vérification de l'équilibre</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(train2<span class="sc">$</span>Outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
410 410 </code></pre>
</div>
</div>
</section>
<section id="standardisation-des-données" class="level3">
<h3 class="anchored" data-anchor-id="standardisation-des-données">4- Standardisation des données</h3>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-28_530aeda32bd8a9a508203fa98d0fff83">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">=</span> train2[,<span class="sc">-</span><span class="dv">13</span>]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">=</span> train2[,<span class="dv">13</span>]</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcul de la moyenne et de l'écart type pour le jeu de données d'entraînement</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>mean_train <span class="ot">=</span> <span class="fu">apply</span>(X_train, <span class="dv">2</span>, mean)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>std_train <span class="ot">=</span> <span class="fu">apply</span>(X_train, <span class="dv">2</span>, sd)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Application de la standardisation sur le jeu de données d'entraînement</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>X_train_scaled <span class="ot">=</span> <span class="fu">sweep</span>(<span class="fu">sweep</span>(X_train, <span class="dv">2</span>, mean_train, <span class="st">"-"</span>), <span class="dv">2</span>, std_train, <span class="st">"/"</span>)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Application de la même standardisation sur le jeu de données de test</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Utiliser les moyennes et écarts types du jeu d'entraînement</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">=</span> test2[,<span class="sc">-</span><span class="dv">13</span>]</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">=</span> test2[, <span class="dv">13</span>]</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>X_test_scaled <span class="ot">=</span> <span class="fu">sweep</span>(<span class="fu">sweep</span>(X_test, <span class="dv">2</span>, mean_train, <span class="st">"-"</span>), <span class="dv">2</span>, std_train, <span class="st">"/"</span>)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Assembler en df pour les modeles prenant features et labels en entrée</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">=</span> X_train_scaled</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>df_train<span class="sc">$</span>Outcome <span class="ot">=</span> y_train</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>df_test <span class="ot">=</span> X_test_scaled</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>df_test<span class="sc">$</span>Outcome <span class="ot">=</span> y_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="iv--prédictions-affinées" class="level2">
<h2 class="anchored" data-anchor-id="iv--prédictions-affinées">IV- Prédictions affinées</h2>
<section id="vote-de-majorité" class="level3">
<h3 class="anchored" data-anchor-id="vote-de-majorité">1- Vote de majorité:</h3>
<p>L’idée est d’entrainer les divers algorithmes vus précédemment sur le dataset transformé. Et de récolter pour chacun ses prédictions. La prédiction finale pour une observation correspondera à la majorité de prédictions pour une observation.</p>
<ul>
<li>KNN</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(class)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>mod_knn_2 <span class="ot">=</span> <span class="fu">knn</span>(X_train_scaled,X_test_scaled,y_train,<span class="at">k=</span><span class="dv">12</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>tbc_knn_2 <span class="ot">=</span> <span class="fu">mean</span>(mod_knn_2 <span class="sc">==</span> y_test)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>tbc_knn_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.73</code></pre>
</div>
</div>
<ul>
<li>Arbre de décision</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'rpart'</span>);<span class="fu">library</span>(<span class="st">'rpart.plot'</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle d'arbre de décision avec la méthode cart</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>mod_dt_2 <span class="ot">=</span> <span class="fu">rpart</span>(Outcome<span class="sc">~</span>.,<span class="at">data=</span>df_train)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prédiction sur le set de test</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>p_dt_2 <span class="ot">=</span><span class="fu">predict</span>(mod_dt_2,<span class="at">newdata =</span> df_test,<span class="at">type=</span><span class="st">'class'</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonne classification par arbre de décision :</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>tbc_dt_2 <span class="ot">=</span> <span class="fu">mean</span>(p_dt_2<span class="sc">==</span>df_test<span class="sc">$</span>Outcome)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>tbc_dt_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.79</code></pre>
</div>
</div>
<ul>
<li>Forêts Aléatoires</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modéle RF avec le paramètre mtry minimisant l'erreur OOB</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>mod_rf_2 <span class="ot">=</span> <span class="fu">randomForest</span>(Outcome<span class="sc">~</span>.,<span class="at">data=</span>df_train, <span class="at">ntree=</span><span class="dv">10000</span>, <span class="at">mtry=</span><span class="dv">4</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prédiction</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>p_rf_2<span class="ot">=</span><span class="fu">predict</span>(mod_rf_2,<span class="at">newdata =</span> df_test,<span class="at">type=</span><span class="st">'class'</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonne classification RF</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>tbc_rf_2 <span class="ot">=</span> <span class="fu">mean</span>(p_rf_2<span class="sc">==</span>df_test<span class="sc">$</span>Outcome)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>tbc_rf_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.77</code></pre>
</div>
</div>
<ul>
<li>SVM avec kernel polynomial</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kernlab)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle SVM</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>svm_model_2 <span class="ot">=</span> <span class="fu">ksvm</span>(Outcome <span class="sc">~</span> ., <span class="at">data =</span> df_train, <span class="at">kernel =</span> <span class="st">"polydot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Setting default kernel parameters  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prédictions</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>p_svm_2 <span class="ot">=</span> <span class="fu">predict</span>(svm_model_2, <span class="at">newdata =</span> df_test)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonne classification</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>tbc_svm_2 <span class="ot">=</span> <span class="fu">mean</span>(p_svm_2 <span class="sc">==</span> y_test)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>tbc_svm_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.79</code></pre>
</div>
</div>
<ul>
<li>Régression logistique sans pénalités</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(VGAM)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle de régression logistique </span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>mod_reglog_2 <span class="ot">=</span> <span class="fu">vglm</span>(Outcome <span class="sc">~</span> ., <span class="at">family =</span> <span class="fu">binomialff</span>(<span class="at">link =</span> <span class="st">"logitlink"</span>), <span class="at">data =</span> df_train)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcul de la probabilité d'avoir le diabète</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">predict</span>(mod_reglog_2, <span class="at">newdata =</span> df_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Conversion de la probabilité en classe </span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>p_reglog_2 <span class="ot">=</span> <span class="fu">ifelse</span>(prob <span class="sc">&gt;</span> <span class="fl">0.45</span>, <span class="dv">1</span>, <span class="dv">0</span>) </span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonnes prédictions</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>tbc_reglog_2 <span class="ot">=</span> <span class="fu">mean</span>(p_reglog_2<span class="sc">==</span>y_test)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>tbc_reglog_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8</code></pre>
</div>
</div>
<ul>
<li>Régression pénalisée Lasso, sans optimisation du paramètre lambda</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle de régression Lasso </span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>mod_reglasso_2 <span class="ot">=</span><span class="fu">glmnet</span>(df_train[,<span class="sc">-</span><span class="dv">13</span>],df_train[,<span class="dv">13</span>],<span class="at">alpha=</span><span class="dv">1</span>,<span class="at">family=</span><span class="st">"binomial"</span>,<span class="at">lambda=</span><span class="fl">0.001</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prédiction</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>p_reglasso_2 <span class="ot">=</span> <span class="fu">predict</span>(mod_reglasso_2, <span class="at">newx =</span> <span class="fu">as.matrix</span>(df_test[,<span class="sc">-</span><span class="dv">13</span>]),<span class="at">type=</span><span class="st">'class'</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonnes prédictions</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>tbc_reglasso_2 <span class="ot">=</span> <span class="fu">mean</span>(p_reglasso_2 <span class="sc">==</span> df_test<span class="sc">$</span>Outcome)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>tbc_reglasso_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.79</code></pre>
</div>
</div>
<ul>
<li>Régression pénalisée Lasso avec recherche d’un lambda optimal par cross validation</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle de régression Lasso avec optimisation de Lambda par Cv</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>mod_reglasso_cv_2 <span class="ot">=</span> <span class="fu">cv.glmnet</span>(<span class="fu">as.matrix</span>(df_train[,<span class="sc">-</span><span class="dv">13</span>]), <span class="fu">as.matrix</span>(df_train[,<span class="dv">13</span>]), <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">family=</span><span class="st">"binomial"</span>, <span class="at">nfolds =</span> <span class="dv">82</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Lambda optimal ( ici celle qui minimise le plus l'erreur de la validation croisée)</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>best_lambda_2 <span class="ot">=</span> mod_reglasso_cv_2<span class="sc">$</span>lambda.min <span class="co"># 1se sinon</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajustement d un modèle de régression Lasso avec cette valeur de lambda</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>mod_reglasso_optimise_2 <span class="ot">=</span> <span class="fu">glmnet</span>(df_train[, <span class="sc">-</span><span class="dv">13</span>], df_train<span class="sc">$</span>Outcome, <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">family=</span><span class="st">"binomial"</span>, <span class="at">lambda=</span>best_lambda_2)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>p_reglasso_opt_2 <span class="ot">=</span> <span class="fu">predict</span>(mod_reglasso_optimise_2, <span class="at">newx =</span> <span class="fu">as.matrix</span>(df_test[,<span class="sc">-</span><span class="dv">13</span>]),<span class="at">type=</span><span class="st">'class'</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonnes Classification</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>tbc_reglasso_opt_2 <span class="ot">=</span> <span class="fu">mean</span>(p_reglasso_opt_2 <span class="sc">==</span> df_test<span class="sc">$</span>Outcome)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>tbc_reglasso_opt_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.79</code></pre>
</div>
</div>
<ul>
<li>Refaire une régression logistique sans les variables éliminées par Lasso</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables éliminées par la régression Lasso:</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(mod_reglasso_2, <span class="at">s =</span> best_lambda_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>13 x 1 sparse Matrix of class "dgCMatrix"
                                  s1
(Intercept)              -0.08093357
Pregnancies               0.35992467
Glucose                   0.77892887
BloodPressure            -0.20959572
SkinThickness             0.20113954
Insulin                  -0.77776602
BMI                       0.54328518
DiabetesPedigreeFunction  0.46154811
Age                       0.36401068
log_G                     0.41046823
log_I                     1.02711675
ratio_GI                  .         
produit_GI                .         </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Eliminer ratio_GI et produit_GI de la régréssion logistique</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modèle de régression logistique </span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>mod_reglog_3 <span class="ot">=</span> <span class="fu">vglm</span>(Outcome <span class="sc">~</span>  Pregnancies<span class="sc">+</span>Glucose<span class="sc">+</span>BloodPressure<span class="sc">+</span>SkinThickness<span class="sc">+</span>Insulin<span class="sc">+</span>BMI<span class="sc">+</span>DiabetesPedigreeFunction<span class="sc">+</span>Age<span class="sc">+</span>log_G<span class="sc">+</span>log_I, <span class="at">family =</span> <span class="fu">binomialff</span>(<span class="at">link =</span> <span class="st">"logitlink"</span>), <span class="at">data =</span> df_train)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcul de la probabilité d'avoir le diabète</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>prob3 <span class="ot">=</span> <span class="fu">predict</span>(mod_reglog_2, <span class="at">newdata =</span> df_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Conversion de la probabilité en classe </span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>p_reglog_3 <span class="ot">=</span> <span class="fu">ifelse</span>(prob <span class="sc">&gt;</span> <span class="fl">0.45</span>, <span class="dv">1</span>, <span class="dv">0</span>) </span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Taux de bonnes prédictions</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>tbc_reglog_3 <span class="ot">=</span> <span class="fu">mean</span>(p_reglog_3<span class="sc">==</span>y_test)</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>tbc_reglog_3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"cette régréssion a le même taux de bon classement que la normale, pour la suite nous garderons la première."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cette régréssion a le même taux de bon classement que la normale, pour la suite nous garderons la première."</code></pre>
</div>
</div>
<p>Nous remarquons une amélioration nette de la prédiction au niveau du taux de bon classement nous allons maintenant faire le “vote” pour avoir les prédictions ayant fédéré le maximum d’algorithmes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rassembler toutes les prédictions dans une matrice ou un dataframe</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">KNN =</span> <span class="fu">as.numeric</span>(mod_knn_2)<span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">ArbreDecision =</span> <span class="fu">as.numeric</span>(p_dt_2)<span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ForetsAleatoires =</span> <span class="fu">as.numeric</span>(p_rf_2)<span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">SVM =</span> <span class="fu">as.numeric</span>(p_svm_2)<span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">RegLog =</span> <span class="fu">as.numeric</span>(p_reglog_2),</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">RegLasso =</span> <span class="fu">as.numeric</span>(p_reglasso_2),</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">RegLassoCV =</span> <span class="fu">as.numeric</span>(p_reglasso_opt_2)</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculer la prédiction finale basée sur le vote de majorité</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>predictions_finale <span class="ot">=</span> <span class="fu">apply</span>(predictions, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>  mode_pred <span class="ot">=</span> <span class="fu">names</span>(<span class="fu">sort</span>(<span class="fu">table</span>(x), <span class="at">decreasing =</span> <span class="cn">TRUE</span>))[<span class="dv">1</span>]</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(mode_pred) ) </span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Apprécier les différentes métriques de la prédiction finale issue du vote:</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>conf_matrix_finale_vote <span class="ot">=</span> <span class="fu">confusionMatrix</span>(<span class="fu">factor</span>(predictions_finale), df_test<span class="sc">$</span>Outcome, <span class="at">positive =</span><span class="st">'1'</span>)</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>conf_matrix_finale_vote</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  0  1
         0 49  7
         1 14 30
                                          
               Accuracy : 0.79            
                 95% CI : (0.6971, 0.8651)
    No Information Rate : 0.63            
    P-Value [Acc &gt; NIR] : 0.0004297       
                                          
                  Kappa : 0.5665          
                                          
 Mcnemar's Test P-Value : 0.1904303       
                                          
            Sensitivity : 0.8108          
            Specificity : 0.7778          
         Pos Pred Value : 0.6818          
         Neg Pred Value : 0.8750          
             Prevalence : 0.3700          
         Detection Rate : 0.3000          
   Detection Prevalence : 0.4400          
      Balanced Accuracy : 0.7943          
                                          
       'Positive' Class : 1               
                                          </code></pre>
</div>
</div>
<ul>
<li><p>Interprétation des résultats de la table de Confusion</p>
<ul>
<li><p>Vrais Positifs (VP): 30- Le modèle a correctement identifié 30 cas de diabète.</p></li>
<li><p>Faux Positifs (FP): 14 - Le modèle a incorrectement prédit 12 cas comme étant diabétiques alors qu’ils ne l’étaient pas.</p></li>
<li><p>Vrais Négatifs (VN): 49 - Le modèle a correctement identifié 49 cas non diabétiques.</p></li>
<li><p>Faux Négatifs (FN): 7 - Le modèle a manqué 7 cas de diabète, les classant incorrectement comme non diabétiques.</p></li>
</ul>
<p>Le modèle semble avoir profité de la sagesse de l’ensemble pour donner un bon taux de bonnes prédictions, de l’ordre du 80 %.</p>
<p>En plus, dans les erreurs que le modèle a fait, l’erreur de type 2 (faux négatif) est minime, l’erreur se concentre en type 1 ( faux positif ), ce qui est à privilégier sur des prédictions de pathologies.</p></li>
</ul>
</section>
<section id="modèle-de-réseau-neuronal-dense" class="level3">
<h3 class="anchored" data-anchor-id="modèle-de-réseau-neuronal-dense">2- Modèle de réseau neuronal dense</h3>
<p>Par curiosité, et pour observer le comportement d’un modèle de réseaux de neurones sur ce genre de données, plusieurs modèles denses ont été essayé, avec diverses longueurs et profondeurs de couches, voilà un exemple :</p>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-39_6b7ea22e1c8784f09214d65ddedd917d">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construction des couches</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">4</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">12</span>), <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">kernel_regularizer =</span> <span class="fu">regularizer_l2</span>(<span class="fl">0.001</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="at">rate =</span> <span class="fl">0.2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">4</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">kernel_regularizer =</span> <span class="fu">regularizer_l2</span>(<span class="fl">0.001</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="at">rate =</span> <span class="fl">0.2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">4</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">kernel_regularizer =</span> <span class="fu">regularizer_l2</span>(<span class="fl">0.001</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="at">rate =</span> <span class="fl">0.2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">'sigmoid'</span>)</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Compilation avec les paramètres adaptés </span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">'binary_crossentropy'</span>,</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="st">'adam'</span>,</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">'accuracy'</span>)</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-40_1c7a1adf2635fb28b99f4e6ece733fa5">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Entraînement</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(X_train_scaled), <span class="fu">as.numeric</span>(y_train),</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">300</span>,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">820</span>,</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-41_873eee6a60b731bad5d68bd8412deee7">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># évaluation</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(<span class="fu">as.matrix</span>(X_test), <span class="fu">as.numeric</span>(y_test))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>4/4 [==============================] - 0s 0s/step - loss: -456.6326 - accuracy: 0.6300      loss  accuracy  -456.6326    0.6300 

Tous les modèles ont eu des résultats médiocres de l'ordre de 60-63 %, 

ce qui était prévisible avec aussi peu d'observations.</code></pre>
</section>
</section>
<section id="v--importance-des-variables-pour-le-modèle-le-plus-performant" class="level2">
<h2 class="anchored" data-anchor-id="v--importance-des-variables-pour-le-modèle-le-plus-performant">v- Importance des variables pour le modèle le plus performant</h2>
<p>Le modèle ayant obtenu la meilleure performance après bonne préparation des données est le modèle de la régression logistique.</p>
<ul>
<li>Significativité des coefficients de la régression</li>
</ul>
<div class="cell" data-hash="DM_Diabetes_cache/html/unnamed-chunk-42_735420dfe9955adeabb025551a1a709d">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualiser un sommaire du modèle</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_reglog_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
vglm(formula = Outcome ~ ., family = binomialff(link = "logitlink"), 
    data = df_train)

Coefficients: 
                         Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)              -0.13306    0.11065  -1.203 0.229123    
Pregnancies               0.36940    0.11276   3.276 0.001052 ** 
Glucose                   2.29494    1.11668   2.055 0.039865 *  
BloodPressure            -0.25271    0.11105  -2.276 0.022866 *  
SkinThickness             0.20700    0.13201   1.568 0.116861    
Insulin                  -1.75951    0.84652  -2.079 0.037661 *  
BMI                       0.53785    0.14563   3.693 0.000221 ***
DiabetesPedigreeFunction  0.47500    0.09960   4.769 1.85e-06 ***
Age                       0.32165    0.12417   2.591 0.009583 ** 
log_G                    -0.05503    2.15799  -0.026 0.979656    
log_I                     9.29472    3.94865   2.354 0.018578 *  
ratio_GI                  2.13674    1.18762   1.799 0.071990 .  
produit_GI               -6.27715    6.04832  -1.038 0.299348    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Name of linear predictor: logitlink(prob) 

Residual deviance: 720.8577 on 807 degrees of freedom

Log-likelihood: -360.4289 on 807 degrees of freedom

Number of Fisher scoring iterations: 6 

No Hauck-Donner effect found in any of the estimates</code></pre>
</div>
</div>
<p>Par ordre décroissant de significativité, et avec un seuil alpha de 0.05, la régression logistique sur les données prétraitées et normalisées, donne:</p>
<ul>
<li><p>DiabetesPedigreeFunction (fonction de patrimoine héréditaire diabétique) : Le coefficient positif de 0,47061 est très significatif (p-value &lt; 0,001), indiquant qu’un score élevé de cette fonction est lié à un log-odd ( log(p/1-p)) plus élevée de développer le diabète, donc une plus grande probabilité de développer le diabète.</p></li>
<li><p>Pregnancies (nombre de grossesses) : Le coefficient positif de 0,52058 est très significatif (p-value &lt; 0,001). Cela signifie qu’un nombre élevé de grossesses est associé à un risque accru de développer le diabète.</p></li>
<li><p>Insulin (insuline) : Le coefficient négatif de -2,05509 Cela suggère qu’un niveau élevé d’insuline est associé à un risque réduit de diabète, ce qui est contre intuitif, car ce dataset est plutot orienté sur le diabète insulino-résistant, dont les symptomes sont une demande en insuline plus élevée.</p></li>
</ul>
<p>Il existe Plusieurs explications possibles pour ce résultat contre intuitif:</p>
<p>Des cas de diabète de type 1, insulino-dépendant et qui se manifeste par une absence de sécrétion d’insuline.</p>
<p>Le modèle pourrait également capturer des aspects complexes de la relation entre la sécrétion d’insuline et l’insulinorésistance, pour le modèle des niveaux élevés d’insuline pourraient indiquer une meilleure capacité de sécrétion d’insuline en réponse à l’insulinorésistance, ce qui pourrait être interprété par le modèle comme un facteur réduisant le risque immédiat de diabète.</p>
<p>Ainsi que l’imputation, les erreurs de mesure etc..</p>
<ul>
<li><p>SkinThickness (épaisseur de la peau du triceps) : Le coefficient est positif de 0,32049, ce qui signifie qu’une plus grande épaisseur de la peau est liée à un risque accru de diabète.Ce qui est compatible avec la maladie recherchée, l’épaississement de la peau du triceps est synonyme de surpoids souvent corrélé à une consommation excessive de sucres, ce qui rend résistant à l’insuline.</p></li>
<li><p>ratio_GI ( log(glucose)/log(insuline)) : Le coefficient positif de 2,47970, indiquant qu’un ratio élevé de glucose sur insuline est associé à une probabilité plus élevée de développer le diabète. En effet l’insuline est censé baisser le taux de glucose dans le sang, un taux élevé de glucose malgré la présence d’insuline est symptôme du diabète de type 2.</p></li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>En conclusion, l’étude sur la prédiction du diabète par classification supervisée des données Pima, a permis d’explorer diverses méthodes et techniques sur un jeu de données réel, allant du prétraitement simple à l’ingénierie des variables et l’équilibrage des données. Les résultats obtenus mettent en évidence l’importance d’une préparation minutieuse des données, incluant le nettoyage des données, l’imputation des valeurs manquantes, la détection et le traitement des valeurs aberrantes, ainsi que l’équilibrage des classes pour améliorer la performance des modèles.</p>
<p>La variété des modèles testés, allant des plus proches voisins, aux arbres de décision, en passant par les forêts aléatoires, les SVM, et la régression logistique, a montré des performances variées mais globalement prometteuses, avec des taux de bonne classification allant jusqu’à 80% après optimisation et préparation adéquate des données. L’application de techniques telles que le suréchantillonnage SMOTE pour l’équilibrage des classes, la standardisation des variables, et la création de nouvelles variables à partir des données existantes, a permis d’augmenter significativement la précision des prédictions.</p>
<p>L’analyse des coefficients de la régression logistique a révélé l’importance de plusieurs variables dans la prédiction du diabète, notamment la fonction de patrimoine héréditaire diabétique (DiabetesPedigreeFunction), le nombre de grossesses, et le niveau d’insuline, entre autres. Ces résultats soulignent l’importance de comprendre les relations complexes entre différents facteurs de risque et la maladie, et montrent le potentiel de la classification supervisée dans l’aide à la prédiction et à la prévention du diabète.</p>
<p>Il est à souligner également, la nécéssité de se méfier d’un taux de bonnes prédictions trop haut sur ce genre de datasets, car souvent ceci est synonyme d’un problème dans la méthodologie.</p>
<p>Enfin, cette étude illustre bien la complexité et les défis inhérents à la modélisation prédictive en santé, notamment la nécessité de disposer de données de haute qualité, l’importance de l’interprétation clinique des modèles, et le potentiel d’amélioration continue des modèles à travers l’expérimentation et l’optimisation.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>